<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Alle Rezepte</title>

    <style>
        body { font-family: Arial; margin: 20px; }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            vertical-align: top;
        }
        th {
            background-color: #f8f8f8;
            position: sticky;
            top: 0;
        }
        th div {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        input[type="text"] {
            padding: 4px;
        }

        .sort-btn {
            cursor: pointer;
            padding: 2px 6px;
            border: 1px solid #aaa;
            background: #eee;
            border-radius: 4px;
            font-size: 10px;
        }
        .delete-btn {
            color: red;
            cursor: pointer;
            font-weight: bold;
        }
        #add-container {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            background: #fafafa;
        }
        #download-btn {
            padding: 6px 12px;
            border: 1px solid #444;
            background: #ddd;
            margin-left: 15px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<h1>
    <a href="index.html" style="text-decoration:none; margin-right:10px; font-size:24px;">üè†</a>
    All Recipes
    <button id="download-btn">Download CSV</button>
</h1>


<div id="add-container">
    <h3>Rezept hinzuf√ºgen</h3>
    <form id="add-form"></form>
    <button id="save-btn">Speichern</button>
    <p id="save-status"></p>
</div>

<table id="recipes-table"></table>

<script>
let originalData = [];
let filteredData = [];
let sortState = {}; // Sortierstatus pro Spalte

async function loadData() {
    const res = await fetch("http://127.0.0.1:8000/all");
    const data = await res.json();

    originalData = data;
    filteredData = [...data];

    renderTable();
    renderAddForm();
}

// ----------------------------------------------
// CSV Download
// ----------------------------------------------
document.getElementById("download-btn").onclick = () => {
    window.location.href = "http://127.0.0.1:8000/download";
};

// ----------------------------------------------
// Tabelle zeichnen
// ----------------------------------------------
function renderTable() {
    const table = document.getElementById("recipes-table");
    if (filteredData.length === 0) {
        table.innerHTML = "<p>Keine Daten gefunden.</p>";
        return;
    }

    const columns = Object.keys(filteredData[0]);

    let html = "<tr>";

    // ------ Kopfzeile mit Sort ------
    columns.forEach(col => {
        html += `
            <th>
                <div>
                    <b>${col}</b>
                    <button class="sort-btn" onclick="sortColumn('${col}')">Sort</button>
                </div>
            </th>
        `;
    });

    // Spalte f√ºr L√∂schen
    html += `<th>L√∂schen</th>`;
    html += "</tr>";

    // ------ Zeilen ------
    filteredData.forEach((row, idx) => {
        html += "<tr>";
        columns.forEach(col => {
            html += `<td>${row[col] ?? ""}</td>`;
        });
        html += `<td><span class="delete-btn" onclick="deleteRow(${idx})">X</span></td>`;
        html += "</tr>";
    });

    table.innerHTML = html;
}

// ----------------------------------------------
// Sortieren
// ----------------------------------------------
function sortColumn(col) {
    if (!sortState[col] || sortState[col] === "desc") {
        sortState[col] = "asc";
        filteredData.sort((a, b) => (a[col] || "").localeCompare(b[col] || ""));
    } else {
        sortState[col] = "desc";
        filteredData.sort((a, b) => (b[col] || "").localeCompare(a[col] || ""));
    }

    renderTable();
}

// ----------------------------------------------
// Zeile l√∂schen mit Popup
// ----------------------------------------------
async function deleteRow(filteredIndex) {
    const realIndex = originalData.indexOf(filteredData[filteredIndex]);

    if (!confirm("Sure you want to delete this entry?")) return;

    await fetch(`http://127.0.0.1:8000/delete/${realIndex}`, {
        method: "DELETE"
    });

    await loadData();
}

// ----------------------------------------------
// Eingabeformular dynamisch erzeugen
// ----------------------------------------------
async function renderAddForm() {
    const res = await fetch("http://127.0.0.1:8000/columns");
    const columns = await res.json();

    const form = document.getElementById("add-form");
    form.innerHTML = "";

    columns.forEach(col => {
        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = col;
        input.name = col;
        input.style.width = "200px";
        form.appendChild(input);
    });

    document.getElementById("save-btn").onclick = async () => {
        const formData = {};
        columns.forEach(col => {
            formData[col] = form.querySelector(`[name="${col}"]`).value;
        });

        const saveRes = await fetch("http://127.0.0.1:8000/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData)
        });

        if (saveRes.ok) {
            document.getElementById("save-status").innerText = "Gespeichert!";
            loadData();
        } else {
            document.getElementById("save-status").innerText = "Fehler beim Speichern!";
        }
    };
}

loadData();
</script>

</body>
</html>
